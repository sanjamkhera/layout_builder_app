# Flutter Drag & Drop Layout Builder (Canvas + Tabs + Firestore)

A responsive layout builder built with Flutter, BLoC state management, and Firebase Firestore. Users can visually design screens by dragging and dropping predefined widgets (A, B, C, D, etc.) into a canvas, resize them dynamically, and manage multiple layouts using tabs.

## ğŸ¯ Project Overview

Build a **screen designer** where users can:
- Drag predefined widgets (A/B/C/D/...) from a palette
- Drop them into **one canvas** (one panel)
- Move + resize them
- Use **tabs** for multiple layouts
- Save/load layouts as **JSON** in **Firebase Firestore**

Each layout is stored as JSON in Firestore. When the user revisits, the saved layout is fetched and rendered exactly as it was left. Any updates are synced back to Firestore.

---

## ğŸ“ Project Structure

```
lib/
â”œâ”€â”€ bloc/
â”‚   â”œâ”€â”€ layout_bloc.dart      # BLoC that manages layout state and handles all events
â”‚   â”œâ”€â”€ layout_events.dart     # All user actions (Add, Move, Resize, Delete, Tab operations)
â”‚   â””â”€â”€ layout_state.dart      # Current app state (layouts, activeTab, isLoading, error)
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ widget_model.dart      # Single widget data (id, type, position, size)
â”‚   â””â”€â”€ layout_model.dart       # Complete layout data (tabId, tabName, widgets list)
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ layout_repository.dart # Firestore operations (save/load/delete layouts)
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ layout_builder_screen.dart  # Main screen with AppBar, tabs, palette, and canvas
â”‚   â”œâ”€â”€ tabs_control.dart           # Tab management UI (create, switch, delete, rename)
â”‚   â”œâ”€â”€ canvas_widget.dart          # Main canvas area with zoom/pan and drag-drop handling
â”‚   â”œâ”€â”€ draggable_canvas_widget.dart # Individual widget on canvas (moveable and resizable)
â”‚   â”œâ”€â”€ widget_palette.dart         # Sidebar/top bar with draggable widgets (A, B, C, D)
â”‚   â”œâ”€â”€ resize_handle.dart          # Resize handles for widgets (8 handles: corners + edges)
â”‚   â”œâ”€â”€ dot_grid_painter.dart       # Grid pattern background painter for canvas
â”‚   â”œâ”€â”€ zoom_controls.dart          # Zoom in/out/reset controls overlay
â”‚   â”œâ”€â”€ widget_colors.dart          # Color mapping for different widget types
â”‚   â””â”€â”€ test_screen.dart            # Test screen for Firestore sync verification
â”œâ”€â”€ firebase_options.dart      # Firebase configuration (generated by FlutterFire CLI)
â””â”€â”€ main.dart                  # App entry point (Firebase init, Anonymous Auth, MyApp)
```

---

##  Objectives Completed

### PART 1: Project Setup & Architecture 

**Goal:** Create a scalable and maintainable foundation

-  Added dependencies: `flutter_bloc`, `firebase_core`, `cloud_firestore`, `equatable`
-  Configured Firebase for Flutter
-  Generated `firebase_options.dart` via FlutterFire CLI
-  Initialized Firebase in `main.dart`
-  Created folder structure:
  - `lib/presentation/`
  - `lib/bloc/`
  - `lib/models/`
  - `lib/repository/`
-  Created base BLoC architecture (LayoutBloc, Events, State)

**Deliverables:**
-  Firebase connected project
-  Base BLoC architecture

---

### PART 2: Layout Data Model & Firestore Integration 

**Goal:** Define how layouts are stored and retrieved

-  Created `WidgetModel` with:
  - id, type, position (x, y), size (width, height)
  - JSON serialization (`toJson()`, `fromJson()`)
-  Created `LayoutModel` with:
  - tabId, tabName, widgets list
  - JSON serialization (`toJson()`, `fromJson()`)
-  Created Firestore repository:
  - `fetchLayouts()` - loads all layouts from Firestore
  - `saveLayout()` - saves a layout to Firestore
  - `saveAllLayouts()` - saves multiple layouts at once
-  Created test screen to verify Firestore sync
-  Implemented user identification with Firebase Anonymous Authentication
  - Each device gets unique user ID automatically
  - User ID persists across app restarts
  - Complete data isolation between users/devices
-  Initial load on screen open (implemented in Part 3 with UI)

**Deliverables:**
-  Fully working Firestore sync
-  Layout persistence (data survives app restarts)

**Test Results:**
-  Can save layouts to Firestore
-  Can load layouts from Firestore
-  JSON serialization/deserialization working
-  Data persists in cloud storage

---

### PART 3: Canvas & Drag-Drop System 

**Goal:** Enable widget placement

-  Created single canvas widget (`CanvasWidget`)
-  Widget palette side menu with draggable widgets (A, B, C, D)
-  Drag source from palette (`Draggable<String>`)
-  Drop target on canvas (`DragTarget<String>`)
-  Captures actual drop position (not just center)
-  Widgets are draggable on canvas (can be moved around)
-  BLoC integration (sends AddWidgetEvent and MoveWidgetEvent)
-  Initial load on screen open (LoadLayoutsEvent)

**Deliverables:**
-  Widgets can be added via drag & drop
-  All widgets rendered in one panel
-  Widgets can be moved around on canvas

---

### PART 4: Resize & Layout Interaction 

**Goal:** Allow user to resize and manipulate widgets

**Completed:**
-  Added resize handles (8 handles: 4 corners + 4 edges)
-  Update width & height on drag (real-time resize updates)
-  Maintain minimum size constraints (50px minimum)
-  Update layout state via BLoC (ResizeWidgetEvent + MoveWidgetEvent)
-  Re-render canvas efficiently (BlocBuilder for state-driven updates)

**Deliverables:**
-  Resizable widgets
-  Smooth drag + resize UX

---

### PART 5: Multi-Tab Layout Management & Sync 

**Goal:** Support multiple layouts

**Implementation:**
- Created `TabsControl` widget with tab management UI: horizontal scrollable tabs, active tab highlighting, add button, delete with confirmation, rename via long press
- Tab operations: creation with unique IDs, switching via state update, deletion with safety checks, renaming with persistence
- Auto-save integrated: all tab operations automatically dispatch `SaveLayoutEvent` to Firestore
- Conflict handling: Firestore merge strategy prevents data overwrites, safe tab deletion via `FieldValue.delete()`

**Deliverables:**
- Multiple layouts per user with persistent storage per tab
- Complete tab management UI (create, switch, delete, rename)

---

### PART 6: Complete Data Persistence & Restoration Flow 

**Goal:** Ensure layouts persist across app restarts and are properly restored

**Implementation:**
- App initialization: Firebase initializes on startup, Anonymous Authentication restores or creates user ID that persists across restarts
- Automatic layout loading: `LoadLayoutsEvent` dispatched on screen load, fetches all layouts from `layouts/{userId}`, creates default tab if none exist
- Canvas rendering: CanvasWidget uses `BlocBuilder` to display active layout widgets, updates automatically on tab switch
- Real-time updates: user interactions dispatch events to BLoC, state updates immediately, UI rebuilds via `BlocBuilder` for instant feedback
- Auto-save: all operations (add, move, resize, delete widgets; create, delete, rename tabs) automatically trigger `SaveLayoutEvent` with JSON conversion
- Layout restoration: user ID restored on app reopen, layouts fetched and restored with exact widget positions

**Data Flow:**
```
1. App loads â†’ Fetch layouts from Firestore
2. Active tab layout rendered on canvas
3. User drags/resizes widgets
4. LayoutBloc updates state
5. Updated JSON saved to Firestore
6. On revisit â†’ Layout restored
```

**Deliverables:**
- Complete data persistence across app restarts
- Automatic layout restoration with exact positioning
- Real-time state updates with instant UI feedback
- Auto-save on all operations
- User-specific data isolation per device

---

## ğŸ› ï¸ Tech Stack

- **Flutter** - UI framework
- **flutter_bloc** - State management
- **equatable** - Value equality for BLoC
- **Firebase Core** - Firebase initialization
- **Firebase Authentication** - User identification (Anonymous Auth)
- **Cloud Firestore** - Database for layout persistence

---

## ğŸ“¦ Dependencies

```yaml
dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.8
  flutter_bloc: ^8.1.3
  equatable: ^2.0.5
  firebase_core: ^3.6.0
  firebase_auth: ^5.3.1
  cloud_firestore: ^5.4.4

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^6.0.0
```

---

## ğŸ—ï¸ Architecture Overview

### BLoC Pattern

**Events** (`layout_events.dart`):
- `AddWidgetEvent` - Add widget to canvas
- `MoveWidgetEvent` - Move widget on canvas
- `ResizeWidgetEvent` - Resize widget
- `DeleteWidgetEvent` - Delete widget
- `LoadLayoutsEvent` - Load from Firestore
- `SaveLayoutEvent` - Save to Firestore
- `SwitchTabEvent` - Switch active tab
- `CreateTabEvent` - Create new tab
- `DeleteTabEvent` - Delete tab (with confirmation)
- `RenameTabEvent` - Rename tab

**State** (`layout_state.dart`):
- `layouts` - Map of all layouts (by tabId)
- `activeTabId` - Currently active tab
- `isLoading` - Loading indicator
- `error` - Error messages

**BLoC** (`layout_bloc.dart`):
- Handles all events
- Updates state
- Calls repository to save/load from Firestore
- Auto-saves after changes

### Data Models

**WidgetModel**:
- Represents a single widget on canvas
- Contains: id, type, position (x, y), size (width, height)
- JSON serializable for Firestore

**LayoutModel**:
- Represents a complete layout (one tab)
- Contains: tabId, tabName, list of widgets
- JSON serializable for Firestore

### Repository Pattern

**LayoutRepository**:
- `fetchLayouts()` - Loads all layouts from Firestore (per user)
- `saveLayout()` - Saves a layout to Firestore (per user)
- `saveAllLayouts()` - Saves multiple layouts at once (per user)
- `deleteTab()` - Deletes a tab from Firestore (per user)
- `_getUserId()` - Gets unique user ID from Firebase Authentication
- Handles JSON conversion (models â†” Firestore)

### User Identification

**Firebase Anonymous Authentication**:
- Each device automatically gets a unique user ID on app startup
- User ID persists across app restarts (stored locally)
- No UI required - authentication happens automatically in the background
- Each user's layouts are stored in a separate Firestore document: `layouts/{userId}`
- Provides complete data isolation between users/devices

---

## ğŸš€ Getting Started

**Flutter SDK Version:** 3.10.7+

### Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/sanjamkhera/layout_builder_app
   cd layout_builder_app
   ```

2. **Install dependencies**
   ```bash
   flutter pub get
   ```

3. **Run the app**
   
   You can run the app on different platforms:
   
   **Web:**
   ```bash
   flutter run -d chrome
   ```
   
   **macOS:**
   ```bash
   flutter run -d macos
   ```
   
   **iOS (requires Xcode installed):**
   ```bash
   # List available iOS devices/simulators
   flutter devices
   
   # Run on iOS simulator
   flutter run -d ios
   
   # Or run on a connected iPhone/iPad
   flutter run -d <device-id>
   ```
   
   **Android (requires Android Studio installed):**
   ```bash
   # List available Android devices/emulators
   flutter devices
   
   # Run on Android emulator or connected device
   flutter run -d android
   
   # Or run on a specific device
   flutter run -d <device-id>
   ```
   
   **Note:** Make sure you have:
   - **Xcode** installed for iOS development (macOS only)
   - **Android Studio** installed with Android SDK for Android development
   - A connected device or running emulator/simulator

---

## ğŸ§ª Testing

The project includes comprehensive unit tests for BLoC logic and data models.

### Running Tests

**Run all tests:**
```bash
flutter test
```

**Run tests with coverage:**
```bash
flutter test --coverage
```

**Run specific test file:**
```bash
flutter test test/models/widget_model_test.dart
flutter test test/bloc/layout_bloc_test.dart
```

### Test Coverage

**Model Tests** (`test/models/`):
- `widget_model_test.dart` - Tests for WidgetModel serialization, deserialization, and immutability
- `layout_model_test.dart` - Tests for LayoutModel serialization, deserialization, and operations

**BLoC Tests** (`test/bloc/`):
- `layout_bloc_test.dart` - Tests for all event handlers:
  - LoadLayoutsEvent (loading, default tab creation, error handling)
  - AddWidgetEvent (adding widgets, creating layouts)
  - MoveWidgetEvent (moving widgets)
  - ResizeWidgetEvent (resizing widgets)
  - DeleteWidgetEvent (deleting widgets)
  - CreateTabEvent (creating tabs)
  - SwitchTabEvent (switching tabs)
  - RenameTabEvent (renaming tabs)
  - DeleteTabEvent (deleting tabs)
  - SaveLayoutEvent (saving layouts)

### Test Dependencies

- `bloc_test` - Testing utilities for BLoC
- `mockito` - Mocking framework for repository testing
- `build_runner` - Code generation for mocks

### Generating Mocks

If you modify the repository interface, regenerate mocks:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### Manual Testing

A test screen is available at `lib/presentation/test_screen.dart` to verify:
- Firebase connection
- Firestore save/load operations
- JSON serialization/deserialization

---

## ğŸ“ Notes

- **Single Canvas**: All widgets exist in one canvas (not stacked layers)
- **Multiple Layouts**: Each tab represents a separate layout
- **Auto-save**: Layouts are automatically saved to Firestore on changes
- **Persistence**: Layouts persist across app restarts via Firestore
- **User Identification**: Each device gets a unique user ID via Firebase Anonymous Authentication
- **Data Isolation**: Each user's layouts are stored separately in Firestore (no data sharing between users)

---

## ğŸ”„ Data Flow

1. App loads â†’ Firebase initializes â†’ Anonymous authentication (creates unique user ID)
2. Fetch layouts from Firestore using user ID â†’ `layouts/{userId}`
3. Active tab layout rendered on canvas
4. User drags/resizes widgets
5. LayoutBloc updates state
6. Updated JSON saved to Firestore (under user's document)
7. On revisit â†’ Layout restored from Firestore using same user ID

**Firestore Structure:**
```
layouts/
  â”œâ”€â”€ {user1-uid}/     # User 1's layouts
  â”‚   â”œâ”€â”€ tab1: {...}
  â”‚   â””â”€â”€ tab2: {...}
  â”œâ”€â”€ {user2-uid}/     # User 2's layouts
  â”‚   â”œâ”€â”€ tab1: {...}
  â”‚   â””â”€â”€ tab3: {...}
  â””â”€â”€ {user3-uid}/     # User 3's layouts
      â””â”€â”€ tab1: {...}
```

---

## ğŸ“š Resources

- [Flutter Documentation](https://flutter.dev/docs)
- [BLoC Pattern](https://bloclibrary.dev/)
- [Firebase Firestore](https://firebase.google.com/docs/firestore)
- [FlutterFire](https://firebase.flutter.dev/)

---

## ğŸ“„ License

This project is part of an employment assessment
